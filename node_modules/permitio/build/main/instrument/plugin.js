"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.hook = void 0;
const require_in_the_middle_1 = __importDefault(require("require-in-the-middle"));
/**
 * Plugin (hook) into frameworks (Express) and track created apps
 */
function hook(appManager, logger) {
    //  Plugin into the http/https create server and map the app provided there/then
    require_in_the_middle_1.default(['http', 'https'], undefined, (exports, name) => {
        /**
         * Handler for the proxy
         */
        const handler = {
            get: function (target, prop, receiver) {
                try {
                    // Wrap call for createServer - to catch passed app
                    if (prop === 'createServer') {
                        return (listener) => {
                            appManager.manage(name, listener);
                            // Proxy the call to the original app
                            return Reflect.get(target, prop, receiver)(listener);
                        };
                    }
                }
                catch (error) {
                    logger.error('Failed to plugin into http/https', { error });
                }
                // if not 'creatServer' or if we failed we return the original property
                return Reflect.get(target, prop, receiver);
            },
        };
        /** Create a Proxy and wrap the module */
        try {
            const proxy = new Proxy(exports, handler);
            return proxy;
        }
        catch (error) {
            logger.error('Plugin hook failed to proxy module', { name, error });
            return exports;
        }
    });
}
exports.hook = hook;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2luc3RydW1lbnQvcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGtGQUF5QztBQUt6Qzs7R0FFRztBQUNILFNBQWdCLElBQUksQ0FBQyxVQUFzQixFQUFFLE1BQWM7SUFDekQsZ0ZBQWdGO0lBQ2hGLCtCQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsT0FBWSxFQUFFLElBQVksRUFBRSxFQUFFO1FBQ2hFOztXQUVHO1FBQ0gsTUFBTSxPQUFPLEdBQUc7WUFDZCxHQUFHLEVBQUUsVUFBVSxNQUFXLEVBQUUsSUFBUyxFQUFFLFFBQWE7Z0JBQ2xELElBQUk7b0JBQ0YsbURBQW1EO29CQUNuRCxJQUFJLElBQUksS0FBSyxjQUFjLEVBQUU7d0JBQzNCLE9BQU8sQ0FBQyxRQUFhLEVBQUUsRUFBRTs0QkFDdkIsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7NEJBQ2xDLHFDQUFxQzs0QkFDckMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7d0JBQ3ZELENBQUMsQ0FBQztxQkFDSDtpQkFDRjtnQkFBQyxPQUFPLEtBQUssRUFBRTtvQkFDZCxNQUFNLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztpQkFDN0Q7Z0JBQ0QsdUVBQXVFO2dCQUN2RSxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztZQUM3QyxDQUFDO1NBQ0YsQ0FBQztRQUVGLHlDQUF5QztRQUN6QyxJQUFJO1lBQ0YsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzFDLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE1BQU0sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNwRSxPQUFPLE9BQU8sQ0FBQztTQUNoQjtJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQWxDRCxvQkFrQ0MifQ==