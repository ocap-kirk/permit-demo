"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.mapApp = void 0;
const lodash_1 = __importDefault(require("lodash"));
const registry_1 = require("../../resources/registry");
const decorator_1 = require("../decorator");
const mapExpressApp_1 = require("./mapExpress/mapExpressApp");
const resthole_1 = require("./resthole");
const SIMPLE_REST_NAMING = {
    POST: 'create',
    PUT: 'update',
    DELETE: 'remove',
    GET: 'view',
    LIST: 'list',
};
/**
 *
 * @param {MappedEndpoint} endpoints the endpoints of an application
 * @param {boolean} flat should the tree have only one level (instead of nesting resources - putting each resource under the root directly), Defaults to true
 * @returns {EndpointTree} a nested tree structure of endpoints
 *
 * -- Tree Layouts --
 *    Tree Layout (flat=false) :
 *      root-path -> endpoint-group[{endpoint, {sub-tree}}]
 *
 *    Flat Tree Layout (flat=true) :
 *      root-path -> endpoint-group[endpoints]
 *
 *
 */
function getNestedEndpointsTree(endpoints, flat = true) {
    const sortedEndpoints = lodash_1.default.sortBy(endpoints, 'path');
    const tree = {};
    let currentTree;
    let prev = null;
    let root = null;
    let junction;
    let prevAddedId = false;
    //  Scan through endpoints sorted by path
    lodash_1.default.forEach(sortedEndpoints, (endpoint) => {
        // New root (No current root, or previous root is just '/' or we are building a flat tree )
        if (root === null ||
            (prev === null || prev === void 0 ? void 0 : prev.path) === '/' ||
            !endpoint.path.startsWith(root.path) ||
            (prevAddedId && flat)) {
            junction = root = endpoint;
            tree[root.path] = [root];
            currentTree = tree;
            prev = null;
            // Paths are nested,  no id was added
        }
        else if (prev !== null && endpoint.path.startsWith(prev.path) && !prevAddedId) {
            if (flat) {
                tree[root.path].push(endpoint);
            }
            else {
                currentTree[junction.path].push(endpoint);
            }
            // New path under same root (new junction)
        }
        else {
            const newSubTree = { [endpoint.path]: [endpoint] };
            tree[root.path].push(newSubTree);
            currentTree = newSubTree;
            junction = endpoint;
        }
        // Prepare for next item
        prevAddedId = prev !== null && endpoint.keys.length > prev.keys.length;
        prev = endpoint;
    });
    return tree;
}
/**
 * Translate a REST HTTP method to an action name
 */
function getMethodName(method, endpoint, treatGetAsList = false) {
    // if treatGetAsList
    const defactoMethodName = treatGetAsList && method === 'GET' ? 'LIST' : method;
    let value = lodash_1.default.get(endpoint.namedMethods, method, lodash_1.default.get(SIMPLE_REST_NAMING, defactoMethodName, defactoMethodName));
    // '' not a valid function name
    value =
        value.length > 0 ? value : lodash_1.default.get(SIMPLE_REST_NAMING, defactoMethodName, defactoMethodName);
    return lodash_1.default.startCase(value);
}
/**
 * Translate an endpoint path to a resource name
 */
function getResourceNameFromPath(path) {
    // Special case
    if (path === '/') {
        return 'index';
    }
    // all other paths
    return lodash_1.default.join(lodash_1.default.reject(path.split('/'), (i) => i.startsWith(mapExpressApp_1.KEY_DELIMITER)), ' ').trim();
}
/**
 * Translate an endpoint to a resource name
 */
function getResourceNameFromEndpoint(endpoint) {
    return getResourceNameFromPath(endpoint.path);
}
function endpointToActions(endpoint, treatGetAsList = false) {
    return lodash_1.default.map(endpoint.methods, (method) => {
        const func = lodash_1.default.get(endpoint.methodToCallable, method);
        const name = getMethodName(method, endpoint, treatGetAsList);
        const decorations = decorator_1.getDecorations(func);
        const actionDecors = decorations.action || {};
        return new registry_1.ActionDefinition(actionDecors.name || name, actionDecors.title || name, actionDecors.description, endpoint.path, {
            verb: method,
        });
    });
}
function extractDecorations(endpoint) {
    const decorations = lodash_1.default.reject(lodash_1.default.map(endpoint.middleware, (m) => decorator_1.getDecorations(m)), (i) => i === undefined);
    return lodash_1.default.merge({}, ...decorations);
}
function renameDuplicateActions(actions) {
    const actionsByName = lodash_1.default.groupBy(actions, 'name');
    // Check for cases where names repeat then rename subsequent actions
    lodash_1.default.forEach(actionsByName, (actionItems) => {
        if (actionItems.length > 1) {
            // rename in place
            const counter = 1;
            // Rename all but the first
            for (const action of lodash_1.default.slice(actionItems, 1)) {
                const newName = `${action.name}-${counter}`;
                // If title is derived from name update it too
                if (action.name === action.title) {
                    action.title = newName;
                }
                action.name = newName;
            }
        }
    });
    return actions;
}
function endpointToResource(endpoint, children, groupPath) {
    var _a;
    const resourceType = 'rest';
    const hasChildWithGet = lodash_1.default.includes(lodash_1.default.flatMap(children, 'methods'), 'GET');
    const childActions = lodash_1.default.flatMap(children, (child) => endpointToActions(child));
    // Map our direct endpoint to actions
    // If we have a child with 'get' method - our own 'get' should be 'list'
    const ownActions = endpointToActions(endpoint, hasChildWithGet);
    const childrenResourceDecorations = lodash_1.default.map(children, (child) => { var _a; return (_a = extractDecorations(child)) === null || _a === void 0 ? void 0 : _a.resource; });
    const resourceDecorations = (_a = extractDecorations(endpoint)) === null || _a === void 0 ? void 0 : _a.resource;
    const mergedResourceDeco = lodash_1.default.merge({}, ...childrenResourceDecorations, resourceDecorations) || {};
    // combine ownActions with child; rename duplicate names (Safety)
    const allActions = renameDuplicateActions(lodash_1.default.concat(ownActions, childActions));
    let path = groupPath !== undefined ? groupPath : endpoint.path;
    if (endpoint.prefix !== undefined) {
        path = endpoint.prefix + path;
    }
    return {
        name: mergedResourceDeco.name ||
            (groupPath ? getResourceNameFromPath(groupPath) : getResourceNameFromEndpoint(endpoint)),
        type: mergedResourceDeco.type || resourceType,
        path: path,
        description: mergedResourceDeco.description || '',
        actions: allActions,
    };
}
/**
 *
 * @param tree Endpoint tree to augment
 * @param endpoints endpoints the tree is based on
 * Groups routes that seem to belong to a REST-hole pattern and set them together in the tree
 * @returns a new updated tree
 */
function augmentEndpointTreeForRestHole(tree, endpoints) {
    const newTree = {};
    // Get rest-hole groups, and attempt to rename their methods
    const groups = resthole_1.nameEndpointsInRestHoleGroups(resthole_1.groupRestHoleEndpoints(endpoints));
    // clean every branch of the tree of items moved to a REST-hole group
    lodash_1.default.forEach(tree, (branch, branchPath) => {
        const groupsForBranch = {};
        const newBranch = lodash_1.default.reject(branch, (ep) => {
            // if It's a regular MappedEndpoint (And not EndpointGroup/EndpointTree)
            if (ep.path) {
                // Check if the EP matches a group
                const matchingGroup = resthole_1.findGroupForPath(ep.path, groups);
                if (matchingGroup) {
                    groupsForBranch[matchingGroup.name] = matchingGroup.endpoints;
                    // remove EP
                    return true;
                }
            }
            // Keep EP as is
            return false;
        });
        // Save the new branch to the new tree (if it survived the trimming)
        if (newBranch.length > 0) {
            newTree[branchPath] = newBranch;
        }
    });
    lodash_1.default.assign(newTree, groups);
    return newTree;
}
/**
 *
 * @param endpoints Translate endpoints to resources
 */
function endpointsToResources(endpoints) {
    // Layout as tree to more easily match resources with their actions
    const tree = augmentEndpointTreeForRestHole(getNestedEndpointsTree(endpoints, true), endpoints);
    //prettyConsoleLog('TREE', tree);
    return lodash_1.default.map(tree, (endpoints, groupPath) => {
        const [main, ...children] = endpoints;
        return endpointToResource(main, children, groupPath);
    });
}
function isExpressApp(app) {
    // finger printing express
    return app.stack !== undefined || (app._router && app._router.stack !== undefined);
}
function removePrefix(endpoint, prefixes) {
    const newEndpoint = lodash_1.default.cloneDeep(endpoint);
    for (const prefix of prefixes) {
        if (newEndpoint.path.startsWith(prefix)) {
            newEndpoint.path = newEndpoint.path.substring(prefix.length);
            newEndpoint.prefix = prefix;
            break; // only one prefix is removed
        }
    }
    return newEndpoint;
}
function mapApp(app, prefixes, logger) {
    if (isExpressApp(app)) {
        logger.debug('Mapping Express App');
        const endpoints = mapExpressApp_1.mapExpressAppEndpoints(app);
        // these endpoints paths were trimmed of prefixes that should be ignored, i.e: /v1 or /api/v1
        // by removing the prefixes, we can get a more accurate "guess" what are the resources and actions are
        const trimmedEndpoints = prefixes.length == 0
            ? endpoints
            : endpoints.map((endpoint) => removePrefix(endpoint, prefixes));
        const resources = endpointsToResources(trimmedEndpoints);
        return { resources, endpoints };
    }
    else {
        logger.debug('Unknown app type', { app });
    }
    return { resources: [], endpoints: [] };
}
exports.mapApp = mapApp;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwTWFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2luc3RydW1lbnQvYXBwTWFwcGVyL2FwcE1hcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvREFBdUI7QUFJdkIsdURBQTREO0FBQzVELDRDQUErRDtBQUUvRCw4REFBbUY7QUFDbkYseUNBSW9CO0FBR3BCLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsSUFBSSxFQUFFLFFBQVE7SUFDZCxHQUFHLEVBQUUsUUFBUTtJQUNiLE1BQU0sRUFBRSxRQUFRO0lBQ2hCLEdBQUcsRUFBRSxNQUFNO0lBQ1gsSUFBSSxFQUFFLE1BQU07Q0FDYixDQUFDO0FBRUY7Ozs7Ozs7Ozs7Ozs7O0dBY0c7QUFDSCxTQUFTLHNCQUFzQixDQUFDLFNBQTJCLEVBQUUsSUFBSSxHQUFHLElBQUk7SUFDdEUsTUFBTSxlQUFlLEdBQUcsZ0JBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRXBELE1BQU0sSUFBSSxHQUFpQixFQUFFLENBQUM7SUFDOUIsSUFBSSxXQUF5QixDQUFDO0lBRTlCLElBQUksSUFBSSxHQUEwQixJQUFJLENBQUM7SUFDdkMsSUFBSSxJQUFJLEdBQTBCLElBQUksQ0FBQztJQUN2QyxJQUFJLFFBQXdCLENBQUM7SUFDN0IsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBQ3hCLHlDQUF5QztJQUN6QyxnQkFBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRTtRQUN0QywyRkFBMkY7UUFDM0YsSUFDRSxJQUFJLEtBQUssSUFBSTtZQUNiLENBQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLElBQUksTUFBSyxHQUFHO1lBQ2xCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUNwQyxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsRUFDckI7WUFDQSxRQUFRLEdBQUcsSUFBSSxHQUFHLFFBQVEsQ0FBQztZQUMzQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsV0FBVyxHQUFHLElBQUksQ0FBQztZQUNuQixJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ1oscUNBQXFDO1NBQ3RDO2FBQU0sSUFBSSxJQUFJLEtBQUssSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUMvRSxJQUFJLElBQUksRUFBRTtnQkFDUixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNoQztpQkFBTTtnQkFDTCxXQUFXLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUMzQztZQUNELDBDQUEwQztTQUMzQzthQUFNO1lBQ0wsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7WUFDbkQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDakMsV0FBVyxHQUFHLFVBQVUsQ0FBQztZQUN6QixRQUFRLEdBQUcsUUFBUSxDQUFDO1NBQ3JCO1FBQ0Qsd0JBQXdCO1FBQ3hCLFdBQVcsR0FBRyxJQUFJLEtBQUssSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3ZFLElBQUksR0FBRyxRQUFRLENBQUM7SUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsYUFBYSxDQUFDLE1BQWMsRUFBRSxRQUF3QixFQUFFLGNBQWMsR0FBRyxLQUFLO0lBQ3JGLG9CQUFvQjtJQUNwQixNQUFNLGlCQUFpQixHQUFHLGNBQWMsSUFBSSxNQUFNLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMvRSxJQUFJLEtBQUssR0FBRyxnQkFBQyxDQUFDLEdBQUcsQ0FDZixRQUFRLENBQUMsWUFBWSxFQUNyQixNQUFNLEVBQ04sZ0JBQUMsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsaUJBQWlCLEVBQUUsaUJBQWlCLENBQUMsQ0FDaEUsQ0FBQztJQUNGLCtCQUErQjtJQUMvQixLQUFLO1FBQ0gsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsZ0JBQUMsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsaUJBQWlCLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztJQUU3RixPQUFPLGdCQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzVCLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsdUJBQXVCLENBQUMsSUFBWTtJQUMzQyxlQUFlO0lBQ2YsSUFBSSxJQUFJLEtBQUssR0FBRyxFQUFFO1FBQ2hCLE9BQU8sT0FBTyxDQUFDO0tBQ2hCO0lBQ0Qsa0JBQWtCO0lBQ2xCLE9BQU8sZ0JBQUMsQ0FBQyxJQUFJLENBQ1gsZ0JBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyw2QkFBYSxDQUFDLENBQUMsRUFDN0QsR0FBRyxDQUNKLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDWCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLDJCQUEyQixDQUFDLFFBQXdCO0lBQzNELE9BQU8sdUJBQXVCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ2hELENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLFFBQXdCLEVBQUUsY0FBYyxHQUFHLEtBQUs7SUFDekUsT0FBTyxnQkFBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUU7UUFDeEMsTUFBTSxJQUFJLEdBQUcsZ0JBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3RELE1BQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzdELE1BQU0sV0FBVyxHQUFHLDBCQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDOUMsT0FBTyxJQUFJLDJCQUFnQixDQUN6QixZQUFZLENBQUMsSUFBSSxJQUFJLElBQUksRUFDekIsWUFBWSxDQUFDLEtBQUssSUFBSSxJQUFJLEVBQzFCLFlBQVksQ0FBQyxXQUFXLEVBQ3hCLFFBQVEsQ0FBQyxJQUFJLEVBQ2I7WUFDRSxJQUFJLEVBQUUsTUFBTTtTQUNiLENBQ0YsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsa0JBQWtCLENBQUMsUUFBd0I7SUFDbEQsTUFBTSxXQUFXLEdBQUcsZ0JBQUMsQ0FBQyxNQUFNLENBQzFCLGdCQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLDBCQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDcEQsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxTQUFTLENBQ3ZCLENBQUM7SUFDRixPQUFPLGdCQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxHQUFHLFdBQVcsQ0FBQyxDQUFDO0FBQ3JDLENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLE9BQTJCO0lBQ3pELE1BQU0sYUFBYSxHQUFHLGdCQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNqRCxvRUFBb0U7SUFDcEUsZ0JBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLENBQUMsV0FBVyxFQUFFLEVBQUU7UUFDdkMsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMxQixrQkFBa0I7WUFDbEIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLDJCQUEyQjtZQUMzQixLQUFLLE1BQU0sTUFBTSxJQUFJLGdCQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRTtnQkFDNUMsTUFBTSxPQUFPLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxJQUFJLE9BQU8sRUFBRSxDQUFDO2dCQUM1Qyw4Q0FBOEM7Z0JBQzlDLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsS0FBSyxFQUFFO29CQUNoQyxNQUFNLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQztpQkFDeEI7Z0JBQ0QsTUFBTSxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7YUFDdkI7U0FDRjtJQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsa0JBQWtCLENBQ3pCLFFBQXdCLEVBQ3hCLFFBQTBCLEVBQzFCLFNBQWtCOztJQUVsQixNQUFNLFlBQVksR0FBRyxNQUFNLENBQUM7SUFDNUIsTUFBTSxlQUFlLEdBQUcsZ0JBQUMsQ0FBQyxRQUFRLENBQUMsZ0JBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzFFLE1BQU0sWUFBWSxHQUFHLGdCQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUM5RSxxQ0FBcUM7SUFDckMsd0VBQXdFO0lBQ3hFLE1BQU0sVUFBVSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUVoRSxNQUFNLDJCQUEyQixHQUFHLGdCQUFDLENBQUMsR0FBRyxDQUN2QyxRQUFRLEVBQ1IsQ0FBQyxLQUFLLEVBQUUsRUFBRSx3QkFBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsMENBQUUsUUFBUSxHQUFBLENBQy9DLENBQUM7SUFDRixNQUFNLG1CQUFtQixTQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQywwQ0FBRSxRQUFRLENBQUM7SUFDbkUsTUFBTSxrQkFBa0IsR0FBRyxnQkFBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsR0FBRywyQkFBMkIsRUFBRSxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVsRyxpRUFBaUU7SUFDakUsTUFBTSxVQUFVLEdBQUcsc0JBQXNCLENBQUMsZ0JBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUM7SUFFOUUsSUFBSSxJQUFJLEdBQUcsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO0lBQy9ELElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7UUFDakMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0tBQy9CO0lBRUQsT0FBTztRQUNMLElBQUksRUFDRixrQkFBa0IsQ0FBQyxJQUFJO1lBQ3ZCLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyx1QkFBdUIsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsMkJBQTJCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUYsSUFBSSxFQUFFLGtCQUFrQixDQUFDLElBQUksSUFBSSxZQUFZO1FBQzdDLElBQUksRUFBRSxJQUFJO1FBQ1YsV0FBVyxFQUFFLGtCQUFrQixDQUFDLFdBQVcsSUFBSSxFQUFFO1FBQ2pELE9BQU8sRUFBRSxVQUFVO0tBQ3BCLENBQUM7QUFDSixDQUFDO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsU0FBUyw4QkFBOEIsQ0FDckMsSUFBa0IsRUFDbEIsU0FBMkI7SUFFM0IsTUFBTSxPQUFPLEdBQWlCLEVBQUUsQ0FBQztJQUNqQyw0REFBNEQ7SUFDNUQsTUFBTSxNQUFNLEdBQUcsd0NBQTZCLENBQUMsaUNBQXNCLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUNoRixxRUFBcUU7SUFDckUsZ0JBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxFQUFFO1FBQ3JDLE1BQU0sZUFBZSxHQUFxQyxFQUFFLENBQUM7UUFDN0QsTUFBTSxTQUFTLEdBQWtCLGdCQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQ3ZELHdFQUF3RTtZQUN4RSxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUU7Z0JBQ1gsa0NBQWtDO2dCQUNsQyxNQUFNLGFBQWEsR0FBRywyQkFBZ0IsQ0FBRSxFQUFxQixDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDNUUsSUFBSSxhQUFhLEVBQUU7b0JBQ2pCLGVBQWUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQztvQkFDOUQsWUFBWTtvQkFDWixPQUFPLElBQUksQ0FBQztpQkFDYjthQUNGO1lBQ0QsZ0JBQWdCO1lBQ2hCLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7UUFDSCxvRUFBb0U7UUFDcEUsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN4QixPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsU0FBUyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxnQkFBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDMUIsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUNEOzs7R0FHRztBQUNILFNBQVMsb0JBQW9CLENBQUMsU0FBMkI7SUFDdkQsbUVBQW1FO0lBQ25FLE1BQU0sSUFBSSxHQUFHLDhCQUE4QixDQUFDLHNCQUFzQixDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUVoRyxpQ0FBaUM7SUFFakMsT0FBTyxnQkFBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLEVBQUU7UUFDMUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLFFBQVEsQ0FBQyxHQUFxQixTQUFTLENBQUM7UUFDeEQsT0FBTyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLEdBQVE7SUFDNUIsMEJBQTBCO0lBQzFCLE9BQU8sR0FBRyxDQUFDLEtBQUssS0FBSyxTQUFTLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDO0FBQ3JGLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxRQUF3QixFQUFFLFFBQWtCO0lBQ2hFLE1BQU0sV0FBVyxHQUFtQixnQkFBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMxRCxLQUFLLE1BQU0sTUFBTSxJQUFJLFFBQVEsRUFBRTtRQUM3QixJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3ZDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzdELFdBQVcsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1lBQzVCLE1BQU0sQ0FBQyw2QkFBNkI7U0FDckM7S0FDRjtJQUNELE9BQU8sV0FBVyxDQUFDO0FBQ3JCLENBQUM7QUFFRCxTQUFnQixNQUFNLENBQ3BCLEdBQVEsRUFDUixRQUFrQixFQUNsQixNQUFjO0lBRWQsSUFBSSxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDckIsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sU0FBUyxHQUFHLHNDQUFzQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzlDLDZGQUE2RjtRQUM3RixzR0FBc0c7UUFDdEcsTUFBTSxnQkFBZ0IsR0FDcEIsUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxTQUFTO1lBQ1gsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNwRSxNQUFNLFNBQVMsR0FBRyxvQkFBb0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3pELE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLENBQUM7S0FDakM7U0FBTTtRQUNMLE1BQU0sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0tBQzNDO0lBQ0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLEVBQUUsRUFBRSxDQUFDO0FBQzFDLENBQUM7QUFwQkQsd0JBb0JDIn0=