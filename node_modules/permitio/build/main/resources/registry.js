"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ResourceRegistry = exports.ResourceDefinition = exports.ActionDefinition = exports.extractPatternAndContext = exports.NO_VERB = void 0;
const context_1 = require("../utils/context");
const dict_1 = require("../utils/dict");
const regex_1 = require("../utils/regex");
exports.NO_VERB = 'DEFAULT';
function extractPatternAndContext(path) {
    if (path.endsWith('/')) {
        path = path.slice(0, -1); // remove last "/"
    }
    const regex = /\:(\w+)/;
    const PLACEHOLDER = '(\\w+)';
    const matches = (0, regex_1.matchAll)(regex, path);
    const parts = [];
    const contextVars = [];
    let currentIndex = 0;
    for (const match of matches) {
        // save param name to context vars
        contextVars.push(match.groups[1]);
        // push (escaped) chunk before match
        parts.push((0, regex_1.escapeRegex)(path.slice(currentIndex, match.start)));
        // push placeholder regex instead of match
        parts.push(PLACEHOLDER);
        // advance the index after the match end
        currentIndex += match.start + match.length;
    }
    if (currentIndex < path.length) {
        parts.push((0, regex_1.escapeRegex)(path.slice(currentIndex)));
    }
    const pattern = new RegExp('^' + parts.join('') + '\\/?$');
    return {
        pattern: pattern,
        contextVars: contextVars,
    };
}
exports.extractPatternAndContext = extractPatternAndContext;
class ActionDefinition {
    constructor(name, title, description, path, attributes = {}, resourceId) {
        this.name = name;
        this.title = title;
        this.description = description;
        this.path = path;
        this.attributes = attributes;
        this._resourceId = undefined;
        this._resourceName = '';
        this.resourceId = resourceId;
    }
    get resourceId() {
        return this._resourceId;
    }
    set resourceId(id) {
        this._resourceId = id;
    }
    get resourceName() {
        return this._resourceName;
    }
    set resourceName(name) {
        this._resourceName = name;
    }
    get verb() {
        const v = this.attributes['verb'] || exports.NO_VERB;
        return v.toUpperCase();
    }
    dict() {
        return {
            name: this.name,
            title: this.title,
            description: this.description,
            path: this.path,
            attributes: this.attributes,
            resourceId: this.resourceId,
        };
    }
    repr() {
        return `Action( name=${this.name}, path=${this.path} )`;
    }
}
exports.ActionDefinition = ActionDefinition;
class ResourceDefinition {
    constructor(name, type, path, description, actions = [], attributes = {}) {
        this.name = name;
        this.type = type;
        this.path = path;
        this.description = description;
        this.actions = actions;
        this.attributes = attributes;
        this._remoteId = undefined;
        this.attributes = attributes;
    }
    get remoteId() {
        return this._remoteId;
    }
    set remoteId(id) {
        this._remoteId = id;
    }
    dict() {
        return {
            name: this.name,
            type: this.type,
            path: this.path,
            description: this.description,
            actions: this.actions.map((a) => a.dict()),
            attributes: this.attributes,
        };
    }
    repr() {
        return `Resource(name="${this.name}", path="${this.path}", actions=[${this.actions.map((a) => a.name)}])`;
    }
}
exports.ResourceDefinition = ResourceDefinition;
/**
 * TODO: remove this class completely.
 */
class ResourceSchemaBuilder {
    constructor(name, path, definition, context = {}) {
        this.name = name;
        this.path = path;
        this.definition = definition;
        this.context = context;
        this.definitionPath = (definition === null || definition === void 0 ? void 0 : definition.path) || undefined;
    }
    build() {
        var _a;
        return {
            type: this.name,
            tenant: this.context['tenant'] || '',
            attributes: ((_a = this.definition) === null || _a === void 0 ? void 0 : _a.attributes) || {},
            context: this.context,
        };
    }
}
exports.default = ResourceSchemaBuilder;
class ResourceRegistry {
    constructor() {
        this.resources = {};
        this.alreadySynced = new Set();
        this.processedPaths = {};
        this.actionMatchers = [];
        this.contextStore = new context_1.ContextStore();
    }
    get resourceList() {
        return Object.keys(this.resources).map((k) => this.resources[k]);
    }
    addResource(resource) {
        if (!(resource.name in this.resources)) {
            this.resources[resource.name] = resource;
        }
        resource.actions.forEach((action) => {
            action.resourceName = resource.name;
            const path = action.path ? action.path : resource.path;
            this.processActionPath(path, action.verb, resource.name, action.name);
        });
    }
    addActionToResource(resourceName, action) {
        if (!(resourceName in this.resources)) {
            return undefined;
        }
        const resource = this.resources[resourceName];
        action.resourceId = resource.remoteId;
        action.resourceName = resource.name;
        const existingActions = resource.actions.map((a) => a.name);
        if (!(action.name in existingActions)) {
            resource.actions.push(action);
        }
        const path = action.path ? action.path : resource.path;
        this.processActionPath(path, action.verb, resource.name, action.name);
        return action;
    }
    get paths() {
        return Array.from(Object.keys(this.processedPaths));
    }
    static actionKey(action) {
        return `${action.resourceName}:${action.name}`;
    }
    /**
     * parses the action URI (path) and http verb into a matcher regex with context vars (named params)
     */
    processActionPath(path, verb, resourceName, actionName) {
        let patternAndContext;
        if (this.processedPaths.hasOwnProperty(path)) {
            patternAndContext = this.processedPaths[path];
        }
        else {
            patternAndContext = extractPatternAndContext(path);
            this.processedPaths[path] = patternAndContext;
        }
        this.actionMatchers.push(Object.assign(Object.assign({}, patternAndContext), { resourceName: resourceName, actionName: actionName, verb: verb }));
    }
    isSynced(obj) {
        if (obj instanceof ResourceDefinition) {
            return obj.name in this.alreadySynced;
        }
        if (obj instanceof ActionDefinition) {
            return ResourceRegistry.actionKey(obj) in this.alreadySynced;
        }
        return false;
    }
    markAsSynced(obj, remoteId) {
        if (obj instanceof ResourceDefinition) {
            this.alreadySynced.add(obj.name);
            this.resources[obj.name].remoteId = remoteId;
            obj.actions.forEach((action) => {
                this.alreadySynced.add(ResourceRegistry.actionKey(action));
            });
        }
        if (obj instanceof ActionDefinition) {
            this.alreadySynced.add(ResourceRegistry.actionKey(obj));
        }
    }
    getUrlContext(path, verb = exports.NO_VERB) {
        for (const matcher of this.actionMatchers) {
            if (matcher.verb !== verb && verb !== exports.NO_VERB) {
                continue;
            }
            const match = path.match(matcher.pattern);
            if (match) {
                const resourceDef = this.resources[matcher.resourceName] || undefined;
                let context = {};
                const capturedGroups = match.slice(1); // the first group is the entire string
                if (matcher.contextVars.length == capturedGroups.length) {
                    // TODO dictZip should probably be replaced by lodash _.zipObject
                    context = (0, dict_1.dictZip)(matcher.contextVars, capturedGroups) || {};
                }
                const processedContext = this.contextStore.transform(this.contextStore.getDerivedContext(context));
                const resource = new ResourceSchemaBuilder(matcher.resourceName, path, resourceDef, processedContext).build();
                return {
                    resource: resource,
                    action: matcher.actionName,
                };
            }
        }
        return undefined;
    }
    getMethods() {
        return {
            getUrlContext: this.getUrlContext.bind(this),
        };
    }
}
exports.ResourceRegistry = ResourceRegistry;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0cnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcmVzb3VyY2VzL3JlZ2lzdHJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhDQUFnRDtBQUNoRCx3Q0FBd0M7QUFDeEMsMENBQW1FO0FBa0J0RCxRQUFBLE9BQU8sR0FBRyxTQUFTLENBQUM7QUFFakMsU0FBZ0Isd0JBQXdCLENBQUMsSUFBWTtJQUNuRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDdEIsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxrQkFBa0I7S0FDN0M7SUFFRCxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUM7SUFDeEIsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDO0lBRTdCLE1BQU0sT0FBTyxHQUFpQixJQUFBLGdCQUFRLEVBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRXBELE1BQU0sS0FBSyxHQUFhLEVBQUUsQ0FBQztJQUMzQixNQUFNLFdBQVcsR0FBYSxFQUFFLENBQUM7SUFFakMsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0lBQ3JCLEtBQUssTUFBTSxLQUFLLElBQUksT0FBTyxFQUFFO1FBQzNCLGtDQUFrQztRQUNsQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQyxvQ0FBb0M7UUFDcEMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFBLG1CQUFXLEVBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvRCwwQ0FBMEM7UUFDMUMsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN4Qix3Q0FBd0M7UUFDeEMsWUFBWSxJQUFJLEtBQUssQ0FBQyxL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