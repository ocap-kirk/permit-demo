import Hook from 'require-in-the-middle';
/**
 * Plugin (hook) into frameworks (Express) and track created apps
 */
export function hook(appManager, logger) {
    //  Plugin into the http/https create server and map the app provided there/then
    Hook(['http', 'https'], undefined, (exports, name) => {
        /**
         * Handler for the proxy
         */
        const handler = {
            get: function (target, prop, receiver) {
                try {
                    // Wrap call for createServer - to catch passed app
                    if (prop === 'createServer') {
                        return (listener) => {
                            appManager.manage(name, listener);
                            // Proxy the call to the original app
                            return Reflect.get(target, prop, receiver)(listener);
                        };
                    }
                }
                catch (error) {
                    logger.error('Failed to plugin into http/https', { error });
                }
                // if not 'creatServer' or if we failed we return the original property
                return Reflect.get(target, prop, receiver);
            },
        };
        /** Create a Proxy and wrap the module */
        try {
            const proxy = new Proxy(exports, handler);
            return proxy;
        }
        catch (error) {
            logger.error('Plugin hook failed to proxy module', { name, error });
            return exports;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2luc3RydW1lbnQvcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLHVCQUF1QixDQUFDO0FBS3pDOztHQUVHO0FBQ0gsTUFBTSxVQUFVLElBQUksQ0FBQyxVQUFzQixFQUFFLE1BQWM7SUFDekQsZ0ZBQWdGO0lBQ2hGLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxPQUFZLEVBQUUsSUFBWSxFQUFFLEVBQUU7UUFDaEU7O1dBRUc7UUFDSCxNQUFNLE9BQU8sR0FBRztZQUNkLEdBQUcsRUFBRSxVQUFVLE1BQVcsRUFBRSxJQUFTLEVBQUUsUUFBYTtnQkFDbEQsSUFBSTtvQkFDRixtREFBbUQ7b0JBQ25ELElBQUksSUFBSSxLQUFLLGNBQWMsRUFBRTt3QkFDM0IsT0FBTyxDQUFDLFFBQWEsRUFBRSxFQUFFOzRCQUN2QixVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQzs0QkFDbEMscUNBQXFDOzRCQUNyQyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDdkQsQ0FBQyxDQUFDO3FCQUNIO2lCQUNGO2dCQUFDLE9BQU8sS0FBSyxFQUFFO29CQUNkLE1BQU0sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2lCQUM3RDtnQkFDRCx1RUFBdUU7Z0JBQ3ZFLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzdDLENBQUM7U0FDRixDQUFDO1FBRUYseUNBQXlDO1FBQ3pDLElBQUk7WUFDRixNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDMUMsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3BFLE9BQU8sT0FBTyxDQUFDO1NBQ2hCO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIn0=