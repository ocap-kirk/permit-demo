import _ from 'lodash';
import { ActionDefinition } from '../../resources/registry';
import { getDecorations } from '../decorator';
import { KEY_DELIMITER, mapExpressAppEndpoints } from './mapExpress/mapExpressApp';
import { findGroupForPath, groupRestHoleEndpoints, nameEndpointsInRestHoleGroups, } from './resthole';
const SIMPLE_REST_NAMING = {
    POST: 'create',
    PUT: 'update',
    DELETE: 'remove',
    GET: 'view',
    LIST: 'list',
};
/**
 *
 * @param {MappedEndpoint} endpoints the endpoints of an application
 * @param {boolean} flat should the tree have only one level (instead of nesting resources - putting each resource under the root directly), Defaults to true
 * @returns {EndpointTree} a nested tree structure of endpoints
 *
 * -- Tree Layouts --
 *    Tree Layout (flat=false) :
 *      root-path -> endpoint-group[{endpoint, {sub-tree}}]
 *
 *    Flat Tree Layout (flat=true) :
 *      root-path -> endpoint-group[endpoints]
 *
 *
 */
function getNestedEndpointsTree(endpoints, flat = true) {
    const sortedEndpoints = _.sortBy(endpoints, 'path');
    const tree = {};
    let currentTree;
    let prev = null;
    let root = null;
    let junction;
    let prevAddedId = false;
    //  Scan through endpoints sorted by path
    _.forEach(sortedEndpoints, (endpoint) => {
        // New root (No current root, or previous root is just '/' or we are building a flat tree )
        if (root === null ||
            prev?.path === '/' ||
            !endpoint.path.startsWith(root.path) ||
            (prevAddedId && flat)) {
            junction = root = endpoint;
            tree[root.path] = [root];
            currentTree = tree;
            prev = null;
            // Paths are nested,  no id was added
        }
        else if (prev !== null && endpoint.path.startsWith(prev.path) && !prevAddedId) {
            if (flat) {
                tree[root.path].push(endpoint);
            }
            else {
                currentTree[junction.path].push(endpoint);
            }
            // New path under same root (new junction)
        }
        else {
            const newSubTree = { [endpoint.path]: [endpoint] };
            tree[root.path].push(newSubTree);
            currentTree = newSubTree;
            junction = endpoint;
        }
        // Prepare for next item
        prevAddedId = prev !== null && endpoint.keys.length > prev.keys.length;
        prev = endpoint;
    });
    return tree;
}
/**
 * Translate a REST HTTP method to an action name
 */
function getMethodName(method, endpoint, treatGetAsList = false) {
    // if treatGetAsList
    const defactoMethodName = treatGetAsList && method === 'GET' ? 'LIST' : method;
    let value = _.get(endpoint.namedMethods, method, _.get(SIMPLE_REST_NAMING, defactoMethodName, defactoMethodName));
    // '' not a valid function name
    value =
        value.length > 0 ? value : _.get(SIMPLE_REST_NAMING, defactoMethodName, defactoMethodName);
    return _.startCase(value);
}
/**
 * Translate an endpoint path to a resource name
 */
function getResourceNameFromPath(path) {
    // Special case
    if (path === '/') {
        return 'index';
    }
    // all other paths
    return _.join(_.reject(path.split('/'), (i) => i.startsWith(KEY_DELIMITER)), ' ').trim();
}
/**
 * Translate an endpoint to a resource name
 */
function getResourceNameFromEndpoint(endpoint) {
    return getResourceNameFromPath(endpoint.path);
}
function endpointToActions(endpoint, treatGetAsList = false) {
    return _.map(endpoint.methods, (method) => {
        const func = _.get(endpoint.methodToCallable, method);
        const name = getMethodName(method, endpoint, treatGetAsList);
        const decorations = getDecorations(func);
        const actionDecors = decorations.action || {};
        return new ActionDefinition(actionDecors.name || name, actionDecors.title || name, actionDecors.description, endpoint.path, {
            verb: method,
        });
    });
}
function extractDecorations(endpoint) {
    const decorations = _.reject(_.map(endpoint.middleware, (m) => getDecorations(m)), (i) => i === undefined);
    return _.merge({}, ...decorations);
}
function renameDuplicateActions(actions) {
    const actionsByName = _.groupBy(actions, 'name');
    // Check for cases where names repeat then rename subsequent actions
    _.forEach(actionsByName, (actionItems) => {
        if (actionItems.length > 1) {
            // rename in place
            const counter = 1;
            // Rename all but the first
            for (const action of _.slice(actionItems, 1)) {
                const newName = `${action.name}-${counter}`;
                // If title is derived from name update it too
                if (action.name === action.title) {
                    action.title = newName;
                }
                action.name = newName;
            }
        }
    });
    return actions;
}
function endpointToResource(endpoint, children, groupPath) {
    const resourceType = 'rest';
    const hasChildWithGet = _.includes(_.flatMap(children, 'methods'), 'GET');
    const childActions = _.flatMap(children, (child) => endpointToActions(child));
    // Map our direct endpoint to actions
    // If we have a child with 'get' method - our own 'get' should be 'list'
    const ownActions = endpointToActions(endpoint, hasChildWithGet);
    const childrenResourceDecorations = _.map(children, (child) => extractDecorations(child)?.resource);
    const resourceDecorations = extractDecorations(endpoint)?.resource;
    const mergedResourceDeco = _.merge({}, ...childrenResourceDecorations, resourceDecorations) || {};
    // combine ownActions with child; rename duplicate names (Safety)
    const allActions = renameDuplicateActions(_.concat(ownActions, childActions));
    let path = groupPath !== undefined ? groupPath : endpoint.path;
    if (endpoint.prefix !== undefined) {
        path = endpoint.prefix + path;
    }
    return {
        name: mergedResourceDeco.name ||
            (groupPath ? getResourceNameFromPath(groupPath) : getResourceNameFromEndpoint(endpoint)),
        type: mergedResourceDeco.type || resourceType,
        path: path,
        description: mergedResourceDeco.description || '',
        actions: allActions,
    };
}
/**
 *
 * @param tree Endpoint tree to augment
 * @param endpoints endpoints the tree is based on
 * Groups routes that seem to belong to a REST-hole pattern and set them together in the tree
 * @returns a new updated tree
 */
function augmentEndpointTreeForRestHole(tree, endpoints) {
    const newTree = {};
    // Get rest-hole groups, and attempt to rename their methods
    const groups = nameEndpointsInRestHoleGroups(groupRestHoleEndpoints(endpoints));
    // clean every branch of the tree of items moved to a REST-hole group
    _.forEach(tree, (branch, branchPath) => {
        const groupsForBranch = {};
        const newBranch = _.reject(branch, (ep) => {
            // if It's a regular MappedEndpoint (And not EndpointGroup/EndpointTree)
            if (ep.path) {
                // Check if the EP matches a group
                const matchingGroup = findGroupForPath(ep.path, groups);
                if (matchingGroup) {
                    groupsForBranch[matchingGroup.name] = matchingGroup.endpoints;
                    // remove EP
                    return true;
                }
            }
            // Keep EP as is
            return false;
        });
        // Save the new branch to the new tree (if it survived the trimming)
        if (newBranch.length > 0) {
            newTree[branchPath] = newBranch;
        }
    });
    _.assign(newTree, groups);
    return newTree;
}
/**
 *
 * @param endpoints Translate endpoints to resources
 */
function endpointsToResources(endpoints) {
    // Layout as tree to more easily match resources with their actions
    const tree = augmentEndpointTreeForRestHole(getNestedEndpointsTree(endpoints, true), endpoints);
    //prettyConsoleLog('TREE', tree);
    return _.map(tree, (endpoints, groupPath) => {
        const [main, ...children] = endpoints;
        return endpointToResource(main, children, groupPath);
    });
}
function isExpressApp(app) {
    // finger printing express
    return app.stack !== undefined || (app._router && app._router.stack !== undefined);
}
function removePrefix(endpoint, prefixes) {
    const newEndpoint = _.cloneDeep(endpoint);
    for (const prefix of prefixes) {
        if (newEndpoint.path.startsWith(prefix)) {
            newEndpoint.path = newEndpoint.path.substring(prefix.length);
            newEndpoint.prefix = prefix;
            break; // only one prefix is removed
        }
    }
    return newEndpoint;
}
export function mapApp(app, prefixes, logger) {
    if (isExpressApp(app)) {
        logger.debug('Mapping Express App');
        const endpoints = mapExpressAppEndpoints(app);
        // these endpoints paths were trimmed of prefixes that should be ignored, i.e: /v1 or /api/v1
        // by removing the prefixes, we can get a more accurate "guess" what are the resources and actions are
        const trimmedEndpoints = prefixes.length == 0
            ? endpoints
            : endpoints.map((endpoint) => removePrefix(endpoint, prefixes));
        const resources = endpointsToResources(trimmedEndpoints);
        return { resources, endpoints };
    }
    else {
        logger.debug('Unknown app type', { app });
    }
    return { resources: [], endpoints: [] };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwTWFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2luc3RydW1lbnQvYXBwTWFwcGVyL2FwcE1hcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLENBQUMsTUFBTSxRQUFRLENBQUM7QUFJdkIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDNUQsT0FBTyxFQUFtQixjQUFjLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFL0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ25GLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsc0JBQXNCLEVBQ3RCLDZCQUE2QixHQUM5QixNQUFNLFlBQVksQ0FBQztBQUdwQixNQUFNLGtCQUFrQixHQUFHO0lBQ3pCLElBQUksRUFBRSxRQUFRO0lBQ2QsR0FBRyxFQUFFLFFBQVE7SUFDYixNQUFNLEVBQUUsUUFBUTtJQUNoQixHQUFHLEVBQUUsTUFBTTtJQUNYLElBQUksRUFBRSxNQUFNO0NBQ2IsQ0FBQztBQUVGOzs7Ozs7Ozs7Ozs7OztHQWNHO0FBQ0gsU0FBUyxzQkFBc0IsQ0FBQyxTQUEyQixFQUFFLElBQUksR0FBRyxJQUFJO0lBQ3RFLE1BQU0sZUFBZSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRXBELE1BQU0sSUFBSSxHQUFpQixFQUFFLENBQUM7SUFDOUIsSUFBSSxXQUF5QixDQUFDO0lBRTlCLElBQUksSUFBSSxHQUEwQixJQUFJLENBQUM7SUFDdkMsSUFBSSxJQUFJLEdBQTBCLElBQUksQ0FBQztJQUN2QyxJQUFJLFFBQXdCLENBQUM7SUFDN0IsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBQ3hCLHlDQUF5QztJQUN6QyxDQUFDLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFO1FBQ3RDLDJG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